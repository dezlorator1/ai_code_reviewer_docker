import logging
from pathlib import Path
from datetime import datetime
import requests
import os
import yaml


# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É
config_path = Path(__file__).parent / "config.yml"

# --- –ß–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ ---
with open(config_path) as f:
    config = yaml.safe_load(f)

# --- –ò—Å–ø–æ–ª—å–∑—É–µ–º ---
RESULTS_DIR = Path(config['paths']['OUT_DIR'])
OUT_FILE    = Path(config['paths']['SUMMARY_FILE'])
LOG_FILE    = Path(config['paths']['LOG_FILE'])
MR_CONTEXT_FILE = Path(config['paths']['OUT_DIR']) / "mr_context.md"

API_URL = config['llm']['api_url']
MODEL = config['llm']['model']
MAX_TOKENS = config['llm']['max_tokens']

# ==== LOGGING ====
SCRIPT_NAME = Path(__file__).name
LOG_FILE.parent.mkdir(parents=True, exist_ok=True)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(name)s] %(message)s",
    handlers=[
        logging.FileHandler(LOG_FILE, mode="a"),
        logging.StreamHandler()
    ]
)
log = logging.getLogger(SCRIPT_NAME)

# ==== PROMPT ====
SUMMARY_PROMPT = """–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä OpenSearch –ø–ª–∞–≥–∏–Ω–∞ —Å —è–∑—ã–∫–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤ (–∞–Ω–∞–ª–æ–≥ Splunk).

–ü—Ä–æ–¥—É–∫—Ç –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—Ä—É–ø–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏, –ø–æ—ç—Ç–æ–º—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –≤—ã—è–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤.

–ö–û–ù–¢–ï–ö–°–¢ MERGE REQUEST:
{mr_context}

–†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ï–í–¨–Æ –û–¢–î–ï–õ–¨–ù–´–• –§–ê–ô–õ–û–í:
{reviews}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò:

1. –ü–û–ù–ò–ú–ê–ù–ò–ï –°–¢–†–£–ö–¢–£–†–´:
   - –ö–∞–∂–¥–æ–µ —Ä–µ–≤—å—é –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "### filename"
   - –ü—Ä–æ–±–ª–µ–º—ã –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ **[SEVERITY] [Category]** Line X
   - SEVERITY: CRITICAL / HIGH / MEDIUM / LOW
   - Category: Bug / Security / Performance / Style / API Breaking / Query Breaking / Concurrency

2. –ü–†–ò–û–†–ò–¢–ï–¢ QUERY LANGUAGE –ò–ó–ú–ï–ù–ï–ù–ò–ô:
   - –ï—Å–ª–∏ –≤ —Ä–µ–≤—å—é –ø–æ–º–µ—á–µ–Ω–æ "Query Language Impact: BREAKING" - —ç—Ç–æ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø —Å–µ–∫—Ü–∏—è
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ query parsing, execution, aggregation –í–°–ï–ì–î–ê –≤–∞–∂–Ω–µ–µ –æ–±—ã—á–Ω—ã—Ö –±–∞–≥–æ–≤
   - –§–ª–∞–≥–∏ "Query Breaking" –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Ç–æ–ø–µ –æ—Ç—á–µ—Ç–∞
   - –û–ø–∏—Å—ã–≤–∞–π –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: "–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞—à–±–æ—Ä–¥—ã –º–æ–≥—É—Ç –≤—ã–¥–∞–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"

3. –ê–ù–ê–õ–ò–ó –°–í–Ø–ó–ï–ô –ú–ï–ñ–î–£ –§–ê–ô–õ–ê–ú–ò (–∏—Å–ø–æ–ª—å–∑—É–π MR_CONTEXT):
   - –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ MR —É–∫–∞–∑–∞–Ω—ã –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –Ω–∏–º–∏
   - –ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–µ A –Ω–∞–ø–∏—Å–∞–Ω–æ "–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ –∫–ª–∞—Å—Å B"
   - –ò –≤ MR_CONTEXT –≤–∏–¥–Ω–æ, —á—Ç–æ —Ñ–∞–π–ª B –∏–∑–º–µ–Ω–µ–Ω –∏ –º–µ—Ç–æ–¥ —Ç–∞–º –¥–æ–±–∞–≤–ª–µ–Ω
   - –¢–æ —ç—Ç–æ –ù–ï –ø—Ä–æ–±–ª–µ–º–∞ - –∏—Å–∫–ª—é—á–∏ –∏–∑ –æ—Ç—á–µ—Ç–∞

   - –ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–µ A –∏–∑–º–µ–Ω–µ–Ω –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞
   - –ò –≤ —Ñ–∞–π–ª–µ B –∏–∑–º–µ–Ω–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞
   - –ò –æ–±–∞ —Ñ–∞–π–ª–∞ –≤ —Å–ø–∏—Å–∫–µ MR_CONTEXT
   - –¢–æ —ç—Ç–æ –°–û–ì–õ–ê–°–û–í–ê–ù–ù–û–ï –∏–∑–º–µ–Ω–µ–Ω–∏–µ - –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞

   - –û—Ç–º–µ—á–∞–π –∫–∞–∫ –ø—Ä–æ–±–ª–µ–º—É –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
     * –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥—Ä—É–≥–æ–º
     * –ò –≤ MR_CONTEXT —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ù–ï —É–ø–æ–º—è–Ω—É—Ç–æ

4. –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï –î–£–ë–õ–ò–ö–ê–¢–û–í:
   - –û–¥–Ω–∞ –∏ —Ç–∞ –∂–µ –ø—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ø–æ–º—è–Ω—É—Ç–∞ –≤ —Ä–µ–≤—å—é —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
   - –£–∫–∞–∂–∏ –µ—ë —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Ä–∞–∑
   - –ü–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ —Ñ–∞–π–ª—ã –≥–¥–µ –æ–Ω–∞ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è

5. –ì–†–£–ü–ü–ò–†–û–í–ö–ê:
   - –°–Ω–∞—á–∞–ª–∞ Query Breaking Changes (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è!)
   - –ü–æ—Ç–æ–º –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ (CRITICAL ‚Üí HIGH ‚Üí MEDIUM ‚Üí LOW)
   - –í–Ω—É—Ç—Ä–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (Bug, Security, Performance, –∏ —Ç.–¥.)

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:

---
# –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç –∫–æ–¥-—Ä–µ–≤—å—é

**–î–∞—Ç–∞:** {timestamp}
**–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:** [N]

---

## Executive Summary

[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –≥–ª–∞–≤–Ω—ã–µ —Ä–∏—Å–∫–∏]

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–≥–ª—è–¥—è—Ç —Ö–æ—Ä–æ—à–æ / ‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è / ‚ùå –ï—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–í–ª–∏—è–Ω–∏–µ –Ω–∞ Query Language:** [BREAKING / COMPATIBLE / NONE]

---

## ‚ö†Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Query Language

[–ï—Å–ª–∏ Query Language Impact: BREAKING –∏–ª–∏ COMPATIBLE –≤ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ]

### Breaking Changes
[–ò–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–º–∞—é—â–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã]

**1. [–ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è]**
- **–§–∞–π–ª—ã:** `QueryParser.java:142`
- **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:** [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–µ/—Å–µ–º–∞–Ω—Ç–∏–∫–µ]
- **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** [–∫–∞–∫ —ç—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞—à–±–æ—Ä–¥—ã/–∑–∞–ø—Ä–æ—Å—ã]
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** [–Ω—É–∂–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, deprecation –ø–µ—Ä–∏–æ–¥]

### Compatible Changes
[–ù–æ–≤—ã–µ —Ñ–∏—á–∏, –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ]

- `AggregationExecutor.java:89` ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `percentile()`

---

[–ï—Å–ª–∏ Query Language Impact: NONE –≤–æ –≤—Å–µ—Ö —Ñ–∞–π–ª–∞—Ö]
### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Query Language –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (CRITICAL)

[–ï—Å–ª–∏ –Ω–µ—Ç - –Ω–∞–ø–∏—Å–∞—Ç—å "–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"]

### Bug

**1. [–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã]**
- **–§–∞–π–ª—ã:** `file1.java:42`, `file2.java:15`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** [—á—Ç–æ –Ω–µ —Ç–∞–∫]
- **–í–ª–∏—è–Ω–∏–µ:** [–∫–∞–∫ —ç—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∏—Å—Ç–µ–º—É/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π]
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** [–∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å]

### Security

[–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ]

### Performance

[–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ]

### API Breaking

[–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ]

### Concurrency

[–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ]

---

## üü° –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (HIGH)

[–¢–∞ –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º]

### Bug

**1. [–ù–∞–∑–≤–∞–Ω–∏–µ]**
- **–§–∞–π–ª—ã:** `file:line`
- **–û–ø–∏—Å–∞–Ω–∏–µ:** [–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ]
- **–í–ª–∏—è–Ω–∏–µ:** [–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è]
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** [–∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å]

---

## üü¢ –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (MEDIUM)

[–¢–∞ –∂–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –±–æ–ª–µ–µ –∫—Ä–∞—Ç–∫–æ]

### [Category]

- `file:line` ‚Äî [–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ + –≤–ª–∏—è–Ω–∏–µ]

---

## ‚ö™ –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è (LOW)

### [Category]

- `file:line` ‚Äî [–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ]

---

## ‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

[–ï—Å–ª–∏ –≤ —Ä–µ–≤—å—é —É–ø–æ–º–∏–Ω–∞–ª–∏—Å—å —É–ª—É—á—à–µ–Ω–∏—è - –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∏—Ö]

- [—É–ª—É—á—à–µ–Ω–∏–µ 1]
- [—É–ª—É—á—à–µ–Ω–∏–µ 2]

[–ï—Å–ª–∏ –Ω–µ —É–ø–æ–º–∏–Ω–∞–ª–∏—Å—å - –ø—Ä–æ–ø—É—Å—Ç–∏ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª]

---

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

[–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è - –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞]

### –ü–µ—Ä–µ–¥ –º–µ—Ä–∂–µ–º:
1. [–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å CRITICAL –ø—Ä–æ–±–ª–µ–º—ã]
2. [–ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å]

### –ü–æ—Å–ª–µ –º–µ—Ä–∂–∞:
1. [–ù—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é]
2. [–ù—É–∂–Ω–æ –ª–∏ —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö]
3. [Monitoring: –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è]

---

–ü–†–ê–í–ò–õ–ê:
- –ü–∏—à–∏ –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- Query Language –∏–∑–º–µ–Ω–µ–Ω–∏—è - –ü–†–ò–û–†–ò–¢–ï–¢ ‚Ññ1
- –ò—Å–ø–æ–ª—å–∑—É–π MR_CONTEXT –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏
- –ù–µ –¥—É–±–ª–∏—Ä—É–π —Ä–µ—à—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–µ—Å–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –¥—Ä—É–≥–æ–º —Ñ–∞–π–ª–µ MR)
- –ì—Ä—É–ø–ø–∏—Ä—É–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤–º–µ—Å—Ç–µ
- –£–∫–∞–∑—ã–≤–∞–π –í–°–ï —Ñ–∞–π–ª—ã –≥–¥–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–∞
- –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—É—Å—Ç–∞—è - –Ω–µ –≤–∫–ª—é—á–∞–π –µ—ë –≤ –æ—Ç—á–µ—Ç
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º: –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ñ–∞–π–ª:—Å—Ç—Ä–æ–∫—É
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –ø—Ä–æ–±–ª–µ–º—ã - –±–µ—Ä–∏ —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–µ–≤—å—é
- –í —Ä–∞–∑–¥–µ–ª–µ "–í–ª–∏—è–Ω–∏–µ" –æ–±—ä—è—Å–Ω—è–π –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
"""

# ==== LLM CALL ====
def load_mr_context():
    """Load MR global context if available."""
    if MR_CONTEXT_FILE.exists():
        context = MR_CONTEXT_FILE.read_text(errors="ignore")
        log.info(f"MR_CONTEXT LOADED size={len(context)} bytes")
        return context
    else:
        log.warning(f"MR_CONTEXT FILE NOT FOUND: {MR_CONTEXT_FILE}")
        return "MR context not available."

def call_llm(prompt):
    payload = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": "–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ª–∏–¥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ä–µ–≤—å—é OpenSearch –ø–ª–∞–≥–∏–Ω–æ–≤ —Å —è–∑—ã–∫–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –¢–≤–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –≤—ã—è–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤."},
            {"role": "user", "content": prompt}
        ],
        "temperature": config['llm']['temperature'],
        "max_tokens": MAX_TOKENS
    }

    log.info("SUMMARY LLM REQUEST START")
    start = datetime.now()

    r = requests.post(API_URL, json=payload, timeout=600)
    r.raise_for_status()

    dt = (datetime.now() - start).total_seconds()
    log.info(f"SUMMARY LLM REQUEST FINISH time={dt}s status={r.status_code}")

    return r.json()["choices"][0]["message"]["content"]

# ==== MAIN ====
def main():
    log.info("SUMMARY START")

    # Load MR context
    mr_context = load_mr_context()

    if not RESULTS_DIR.exists():
        log.error(f"RESULTS DIR NOT FOUND: {RESULTS_DIR}")
        return

    reviews = []
    for f in sorted(RESULTS_DIR.glob("*.md")):
        # Skip mr_context.md itself
        if f.name == "mr_context.md":
            continue
        text = f.read_text(errors="ignore")
        reviews.append(f"\n# File: {f.name}\n{text}\n")

    if not reviews:
        log.warning("NO REVIEW FILES FOUND")
        return

    all_reviews = "\n".join(reviews)
    log.info(f"LOADED REVIEWS chars={len(all_reviews)} files={len(reviews)}")

    # Hard cap context to avoid OOM / context overflow
    MAX_CHARS = 250_000   # ~100k tokens rough upper bound
    if len(all_reviews) > MAX_CHARS:
        log.warning(f"REVIEWS TOO LARGE ({len(all_reviews)} chars), TRUNCATING TO {MAX_CHARS}")
        all_reviews = all_reviews[-MAX_CHARS:]

    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    prompt = SUMMARY_PROMPT.format(
        reviews=all_reviews,
        mr_context=mr_context,
        timestamp=timestamp
    )
    log.info(f"SUMMARY PROMPT SIZE chars={len(prompt)}")

    summary = call_llm(prompt)
    OUT_FILE.parent.mkdir(parents=True, exist_ok=True)
    OUT_FILE.write_text(summary)

    log.info(f"SUMMARY WRITTEN {OUT_FILE} bytes={len(summary)}")
    log.info("SUMMARY END")

    # Print summary
    print(f"\n{'='*60}")
    print(f"‚úÖ –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω!")
    print(f"üìÑ –§–∞–π–ª: {OUT_FILE}")
    print(f"üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(reviews)}")
    print(f"{'='*60}\n")

if __name__ == "__main__":
    main()