import logging
from pathlib import Path
from datetime import datetime
import requests
import os
import yaml
import argparse


# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É
config_path = Path(__file__).parent / "config.yml"

# --- –ß–∏—Ç–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ ---
with open(config_path) as f:
    config = yaml.safe_load(f)

# --- –ò—Å–ø–æ–ª—å–∑—É–µ–º ---
RESULTS_DIR = Path(config['paths']['OUT_DIR'])
SUMMARY_PATH = Path(config['paths']['SUMMARY_PATH'])
DEFAULT_OUT_FILE    = Path(config['paths']['SUMMARY_FILE'])
LOG_FILE    = Path(config['paths']['LOG_FILE'])
MR_CONTEXT_FILE = Path(config['paths']['OUT_DIR']) / "mr_context.md"

API_URL = config['llm']['api_url']
MODEL = config['llm']['model']
MAX_TOKENS = config['llm']['max_tokens']

# ==== LOGGING ====
SCRIPT_NAME = Path(__file__).name
LOG_FILE.parent.mkdir(parents=True, exist_ok=True)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(name)s] %(message)s",
    handlers=[
        logging.FileHandler(LOG_FILE, mode="a"),
        logging.StreamHandler()
    ]
)
log = logging.getLogger(SCRIPT_NAME)

# ==== PROMPT ====
SUMMARY_PROMPT = """–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ª–∏–¥, —Å–æ–∑–¥–∞—é—â–∏–π –æ—Ç—á–µ—Ç –¥–ª—è –¢–∏–º–ª–∏–¥–∞.

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:**
- –¢–∏–º–ª–∏–¥ —É–ø—Ä–∞–≤–ª—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –ø—Ä–æ–µ–∫—Ç–æ–≤, –Ω–µ –ø–æ–≥—Ä—É–∂–µ–Ω –≤ –¥–µ—Ç–∞–ª–∏
- –ï–º—É –Ω—É–∂–Ω–∞ —è—Å–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞: –º–æ–∂–Ω–æ –º–µ—Ä–∂–∏—Ç—å –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
- –§–æ–∫—É—Å –Ω–∞ –ö–ê–ß–ï–°–¢–í–ï –ö–û–î–ê –∏ –†–ï–ê–õ–¨–ù–´–• –†–ò–°–ö–ê–•

---

### –ò–°–¢–û–ß–ù–ò–ö 1: MR CONTEXT
{mr_context}

---

### –ò–°–¢–û–ß–ù–ò–ö 2: FILE REVIEWS
{reviews}

---

**–¢–í–û–Ø –ó–ê–î–ê–ß–ê:**

–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ: –º–µ—Ä–∂–∏—Ç—å / –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å / –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å

**–ü–†–ê–í–ò–õ–ê –ê–ì–†–ï–ì–ê–¶–ò–ò:**

**1. –ù–ï –†–ê–ó–î–£–í–ê–ô –§–û–†–ú–ê–õ–¨–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:**
- –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ ‚Üí –Ω–µ —É–ø–æ–º–∏–Ω–∞–π
- –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ JSON ‚Üí –Ω–µ —É–ø–æ–º–∏–Ω–∞–π
- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∏ ‚Üí –Ω–µ —É–ø–æ–º–∏–Ω–∞–π

**2. –§–û–ö–£–°–ò–†–£–ô–°–Ø –ù–ê –†–ï–ê–õ–¨–ù–´–• –†–ò–°–ö–ê–•:**
- TODO/FIXME ‚Üí HIGH/CRITICAL
- –ù–µ–¥–æ–¥–µ–ª–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ ‚Üí CRITICAL
- –ü–ª–æ—Ö–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã (O(n¬≤)) ‚Üí HIGH
- –ò–∑–ª–∏—à–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å ‚Üí MEDIUM
- –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ ‚Üí CRITICAL

**3. BREAKING CHANGES ‚Äî –¢–û–õ–¨–ö–û –†–ï–ê–õ–¨–ù–´–ï:**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è Query Language –∫–æ–º–∞–Ω–¥ ‚Üí BREAKING
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ *RestActions.java ‚Üí BREAKING
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ–Ω—è—é—â–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Üí BREAKING
- –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –ë–ï–ó –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Üí –ù–ï breaking

---

**–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:**

# üõ°Ô∏è –û—Ç—á–µ—Ç –ø–æ Code Review

**–î–∞—Ç–∞:** {timestamp}
**–§–∞–π–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:** {files_count}

---

## üö¶ –í–ï–†–î–ò–ö–¢

[–í—ã–±–µ—Ä–∏ –û–î–ò–ù –∏ –Ω–∞–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ:]

**‚úÖ –í–´–ì–õ–Ø–î–ò–¢ –ë–ï–ó–û–ü–ê–°–ù–û**
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –ø–æ—á–µ–º—É –º–æ–∂–Ω–æ –º–µ—Ä–∂–∏—Ç—å, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ]

**‚ö†Ô∏è –ï–°–¢–¨ –ó–ê–ú–ï–ß–ê–ù–ò–Ø**
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –∫–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞–π–¥–µ–Ω—ã, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∞]

**üõë –ë–õ–û–ö–ò–†–£–Æ–©–ò–ï –ü–†–û–ë–õ–ï–ú–´**
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –º–µ—Ä–∂–∏—Ç—å —Å–µ–π—á–∞—Å]

---

## üéØ –°–£–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–ô

**–¶–µ–ª—å:**
[–ë–∏–∑–Ω–µ—Å-—Ü–µ–ª—å –∏–∑ MR Context ‚Äî 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è]

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
[–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —á—Ç–æ —Å–¥–µ–ª–∞–Ω–æ ‚Äî 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å –¥–µ—Ç–∞–ª—è–º–∏]

**–ú–∞—Å—à—Ç–∞–±:**
- –ù–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤: N
- –ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤: M
- –£–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤: K

---

## üí• BREAKING CHANGES

[–¢–û–õ–¨–ö–û –†–ï–ê–õ–¨–ù–´–ï BREAKING CHANGES ‚Äî –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ]

[–ï—Å–ª–∏ –ù–ï–¢:]
–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.

[–ï—Å–ª–∏ –ï–°–¢–¨, –ø–∏—à–∏ –ü–û–î–†–û–ë–ù–û:]

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ Query Language
**1. –ò–∑–º–µ–Ω–µ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã `stats count()`**
- **–ë—ã–ª–æ:** –í–æ–∑–≤—Ä–∞—â–∞–ª null –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **–°—Ç–∞–ª–æ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0
- **–ì–¥–µ:** `StatsCommand.java:120-130`
- **–í–ª–∏—è–Ω–∏–µ:** –î–∞—à–±–æ—Ä–¥—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `if (result == null)` –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ß—Ç–æ –¥–µ–ª–∞—Ç—å:** –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö (RestActions)
[–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã —Ñ–∞–π–ª—ã *RestActions.java:]
**1. –ò–∑–º–µ–Ω–µ–Ω–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –º–µ—Ç–æ–¥–∞ –≤ QueryRestActions**
- **–ë—ã–ª–æ:** `execute(String query)`
- **–°—Ç–∞–ª–æ:** `execute(String query, int timeout)`
- **–ì–¥–µ:** `QueryRestActions.java:45`
- **–í–ª–∏—è–Ω–∏–µ:** –í–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ timeout —Å–ª–æ–º–∞—é—Ç—Å—è
- **–ß—Ç–æ –¥–µ–ª–∞—Ç—å:** –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –≥–∞–π–¥, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ overload

---

### –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ–Ω—è—é—â–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
**1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `strict_mode`**
- **Default:** false
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –ú–µ–Ω—è–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Äî –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
- **–í–ª–∏—è–Ω–∏–µ:** –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –Ω–∞—á–∞—Ç—å –ø–∞–¥–∞—Ç—å
- **–ì–¥–µ:** `QuerySettings.java:88`
- **–ß—Ç–æ –¥–µ–ª–∞—Ç—å:** –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –º–∏–≥—Ä–∞—Ü–∏–∏

---

## üêõ –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

[–ê–≥—Ä–µ–≥–∏—Ä—É–π, –ø–∏—à–∏ –ü–û–î–†–û–ë–ù–û –¥–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–±–ª–µ–º—ã]

### üî¥ CRITICAL

[–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å—ã–≤–∞–π –∫–∞–∂–¥—É—é –ø—Ä–æ–±–ª–µ–º—É:]

**1. TODO –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**
- **–°—É—Ç—å:** –í –∫–æ–¥–µ –æ—Å—Ç–∞–≤–ª–µ–Ω TODO —Å –∑–∞–≥–ª—É—à–∫–æ–π –≤–º–µ—Å—Ç–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∞–≤
- **–ì–¥–µ:** `AuthService.java:45-50`
- **–ö–æ–¥:**
  ```java
  // TODO: implement authorization check
  return processRequest(request);
  ```
- **–í–ª–∏—è–Ω–∏–µ:** –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
- **–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º Critical

---

**2. –ù–µ–¥–æ–¥–µ–ª–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π –≤ –≥—Ä–∞—Ñ–µ**
- **–°—É—Ç—å:** –ú–µ—Ç–æ–¥ `fillNodeLevel()` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ—ã
- **–ì–¥–µ:** `Graph.java:240-250`
- **–í–ª–∏—è–Ω–∏–µ:** –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ü–∏–∫–ª–æ–≤ –≤ –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø–∞–¥–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
- **–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:** –î–æ–±–∞–≤–∏—Ç—å Set –ø–æ—Å–µ—â–µ–Ω–Ω—ã—Ö —É–∑–ª–æ–≤ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ü–∏–∫–ª–æ–≤

---

### üü° HIGH

**1. –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –æ–±—Ö–æ–¥–∞ –≥—Ä–∞—Ñ–∞**
- **–°—É—Ç—å:** –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ü–∏–∫–ª—ã for —Å–æ–∑–¥–∞—é—Ç O(n¬≤)
- **–ì–¥–µ:** `Graph.java:120-135`
- **–î–µ—Ç–∞–ª–∏:**
  - –ù–∞ 100 —ç–ª–µ–º–µ–Ω—Ç–∞—Ö: ~10k –æ–ø–µ—Ä–∞—Ü–∏–π
  - –ù–∞ 1000 —ç–ª–µ–º–µ–Ω—Ç–∞—Ö: ~1M –æ–ø–µ—Ä–∞—Ü–∏–π
  - –ù–∞ 10000 —ç–ª–µ–º–µ–Ω—Ç–∞—Ö: ~100M –æ–ø–µ—Ä–∞—Ü–∏–π (–∑–∞–≤–∏—Å–∞–Ω–∏–µ)
- **–í–ª–∏—è–Ω–∏–µ:** –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (>1000 —É–∑–ª–æ–≤)
- **–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HashMap<nodeId, Node> –¥–ª—è O(n)

---

**2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏**
- **–°—É—Ç—å:** –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –∫–æ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ 3 —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- **–ì–¥–µ:**
  - `QueryParser.java:88-95`
  - `CommandExecutor.java:120-127`
  - `ResultProcessor.java:200-207`
- **–í–ª–∏—è–Ω–∏–µ:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å 3 –º–µ—Å—Ç–∞ (—Ä–∏—Å–∫ –∑–∞–±—ã—Ç—å)
- **–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:** –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ–±—â–∏–π –º–µ—Ç–æ–¥ `ValidationUtils.validateQuery()`

---

### üü¢ MEDIUM

**1. –ò–∑–ª–∏—à–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Ä–Ω–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤**
- **–ì–¥–µ:** `ResultMapper.java:88`, `QueryProcessor.java:150`
- **–ü—Ä–∏–º–µ—Ä:** `result = x != null ? (x > 10 ? "high" : "low") : "none"`
- **–í–ª–∏—è–Ω–∏–µ:** –ö–æ–¥ —Å–ª–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å
- **–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å if-else –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

**2. –ú–µ—Ç–æ–¥—ã –¥–ª–∏–Ω–Ω–µ–µ 100 —Å—Ç—Ä–æ–∫**
- **–ì–¥–µ:** `GraphService.buildGraph()` (150 —Å—Ç—Ä–æ–∫), `QueryExecutor.execute()` (120 —Å—Ç—Ä–æ–∫)
- **–í–ª–∏—è–Ω–∏–µ:** –°–ª–æ–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å –ª–æ–≥–∏–∫—É, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
- **–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:** –†–∞–∑–±–∏—Ç—å –Ω–∞ –ø–æ–¥–º–µ—Ç–æ–¥—ã

---

### ‚ö™ LOW

[–ö—Ä–∞—Ç–∫–æ, —Å–ø–∏—Å–∫–æ–º:]
- –£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã (3 —Ñ–∞–π–ª–∞)
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã

---

## üìä –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –°–í–û–î–ö–ê

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –º–æ–¥—É–ª–∏:**
- `com.company.query.parser` ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–º–∞–Ω–¥ `stats` –∏ `eval`
- `com.company.model.graph` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `level`, –∏–∑–º–µ–Ω–µ–Ω—ã –∞–ª–≥–æ—Ä–∏—Ç–º—ã –æ–±—Ö–æ–¥–∞
- `com.company.service` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã –ø–æ–¥ –Ω–æ–≤–æ–µ API

**–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∏:**
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ `getMaxDeep()` ‚Üí `getLevels()` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥)
- –£–¥–∞–ª–µ–Ω–∏–µ deprecated –∫–ª–∞—Å—Å–∞ `LegacyParser`
- –í—ã–Ω–æ—Å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã (—á–∞—Å—Ç–∏—á–Ω–æ)

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã –≤–Ω—É—Ç—Ä–∏ MR
- –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ñ–∞–π–ª–∞—Ö —ç—Ç–æ–≥–æ MR

---

## üí° –î–ï–¢–ê–õ–ò –ü–û –§–ê–ô–õ–ê–ú

[–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é —Å –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ñ–∞–π–ª–∞–º]

### Graph.java
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `fillNodes()` –æ–±—ä–µ–¥–∏–Ω—è—é—â–∏–π –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ count –∏ level
- –ò–∑–º–µ–Ω–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π (–¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–µ–∫—É—Ä—Å–∏—è)
- **–†–∏—Å–∫–∏:** –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ—ã, –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å

### Node.java
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `level` –≤ –º–æ–¥–µ–ª—å
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
- **–†–∏—Å–∫–∏:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ, backward compatible (–º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ –ø–æ–ª–µ)

### GraphService.java
- –û–±–Ω–æ–≤–ª–µ–Ω –≤—ã–∑–æ–≤ —Å `fillChildrenCount()` –Ω–∞ `fillNodes()`
- **–†–∏—Å–∫–∏:** –ù–µ—Ç, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ

---

**–ò–¢–û–ì–û–í–´–ï –ü–†–ê–í–ò–õ–ê:**

1. **–Ø–∑—ã–∫:** –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. **–î–µ—Ç–∞–ª—å–Ω–æ—Å—Ç—å:** –ü–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
3. **–§–æ–∫—É—Å:** –†–µ–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏, –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
4. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** –ì—Ä—É–ø–ø–∏—Ä—É–π –ø–æ—Ö–æ–∂–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
5. **Actionable:** –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å

**–ù–ï –ü–ò–®–ò:**
- –ü—Ä–æ —É–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ü—Ä–æ magic numbers (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç checkstyle)
- –ü—Ä–æ —Å—Ç–∏–ª—å –∫–æ–¥–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç checkstyle)
"""

# ==== LLM CALL ====
def load_mr_context():
    """Load MR global context if available."""
    if MR_CONTEXT_FILE.exists():
        context = MR_CONTEXT_FILE.read_text(errors="ignore")
        log.info(f"MR_CONTEXT LOADED size={len(context)} bytes")
        return context
    else:
        log.warning(f"MR_CONTEXT FILE NOT FOUND: {MR_CONTEXT_FILE}")
        return "MR context not available."

def call_llm(prompt):
    payload = {
        "model": MODEL,
        "messages": [
            {"role": "system", "content": "–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ª–∏–¥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ä–µ–≤—å—é OpenSearch –ø–ª–∞–≥–∏–Ω–æ–≤ —Å —è–∑—ã–∫–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –¢–≤–æ–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –≤—ã—è–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤."},
            {"role": "user", "content": prompt}
        ],
        "temperature": config['llm']['temperature'],
        "max_tokens": MAX_TOKENS
    }

    log.info("SUMMARY LLM REQUEST START")
    start = datetime.now()

    r = requests.post(API_URL, json=payload, timeout=600)
    r.raise_for_status()

    dt = (datetime.now() - start).total_seconds()
    log.info(f"SUMMARY LLM REQUEST FINISH time={dt}s status={r.status_code}")

    return r.json()["choices"][0]["message"]["content"]

# ==== MAIN ====
def main():
    # Parse arguments
    parser = argparse.ArgumentParser(description="Summarize code reviews")
    parser.add_argument("--output", help="Custom output filename (optional, default from config)")
    args = parser.parse_args()

    # Determine output file
    OUT_FILE = SUMMARY_PATH / (args.output or DEFAULT_OUT_FILE)

    log.info("SUMMARY START")
    log.info(f"Output file: {OUT_FILE}")
    log.info("SUMMARY START")

    # Load MR context
    mr_context = load_mr_context()

    if not RESULTS_DIR.exists():
        log.error(f"RESULTS DIR NOT FOUND: {RESULTS_DIR}")
        return

    reviews = []
    for f in sorted(RESULTS_DIR.glob("*.md")):
        # Skip mr_context.md itself
        if f.name == "mr_context.md":
            continue
        text = f.read_text(errors="ignore")
        reviews.append(f"\n# File: {f.name}\n{text}\n")

    if not reviews:
        log.warning("NO REVIEW FILES FOUND")
        return

    all_reviews = "\n".join(reviews)
    files_count = len(reviews)
    log.info(f"LOADED REVIEWS chars={len(all_reviews)} files={files_count}")

    # Hard cap context to avoid OOM / context overflow
    MAX_CHARS = 250_000   # ~100k tokens rough upper bound
    if len(all_reviews) > MAX_CHARS:
        log.warning(f"REVIEWS TOO LARGE ({len(all_reviews)} chars), TRUNCATING TO {MAX_CHARS}")
        all_reviews = all_reviews[-MAX_CHARS:]

    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    prompt = SUMMARY_PROMPT.format(
        reviews=all_reviews,
        mr_context=mr_context,
        timestamp=timestamp,
        files_count=files_count
    )
    log.info(f"SUMMARY PROMPT SIZE chars={len(prompt)}")

    summary = call_llm(prompt)
    OUT_FILE.parent.mkdir(parents=True, exist_ok=True)
    OUT_FILE.write_text(summary)

    log.info(f"SUMMARY WRITTEN {OUT_FILE} bytes={len(summary)}")
    log.info("SUMMARY END")

    # Print summary
    print(f"\n{'='*60}")
    print(f"‚úÖ –°–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω!")
    print(f"üìÑ –§–∞–π–ª: {OUT_FILE}")
    print(f"üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(reviews)}")
    print(f"{'='*60}\n")

if __name__ == "__main__":
    main()